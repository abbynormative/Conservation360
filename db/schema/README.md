# schema
## schema.sql
`schema.sql` is a plain text SQL script that creates the MyConservationLife schema in a PostgreSQL database. Running it will delete existing parts of the new schema, and then create the MyConservationLife schema.

### Exporting `schema.sql` from a Heroku PostgreSQL database
`schema.sql` can be generated by dumping the PostgreSQL database of a Heroku app with the following shell commands:

```sh
# Do a Heroku DB backup. hobby-dev accounts can have up to two of these.
heroku pg:backups:capture -a my-conservation-life

# Verify the backup worked
heroku pg:backups:info -a my-conservation-life

# Download the backup
heroku pg:backups:download -a my-conservation-life -o schema.pgdump

# Use pg_restore to create schema.sql
pg_restore schema.pgdump -f schema.sql --clean --if-exists --schema-only --no-privileges --no-owner --schema=public
```

The `schema.sql` produced by this database dump does not commands for installing necessary PostgreSQL extensions. You should manually add `CREATE EXTENSION IF NOT EXISTS` statements to the top of `schema.sql`.

`schema.sql` is also used to reinstall the schema every time an integration test suite is run. However, the default `schema.sql` generated by `pg_restore` contains statements that cause installing the schema to hang. To fix this, delete the following header from `schema.sql` manually:

```sql
SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET client_min_messages = warning;
SET row_security = off;
```

### Importing `schema.sql` into a Heroku PostgreSQL database

```sh
heroku pg:psql -a YOUR_HEROKU_APP -f schema.sql
```